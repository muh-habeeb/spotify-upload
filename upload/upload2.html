<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Upload Songs and Cover Images</title>

    <style>
      * {
        color: #fff;
      }
      body {
        font-family: Arial, sans-serif;
        margin: 0;
        background-color: rgb(20, 19, 73);
        display: flex;
        align-items: center;
        justify-content: center;
        height: 100vh;
        scale: 0.8;
      }

      h1 {
        text-align: center;
      }

      .container {
        max-width: 600px;
        margin: 0 auto;
        background: rgb(24, 26, 136);
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        display: flex;
        align-items: center;
        justify-content: center;
        flex-direction: column;
      }

      label {
        display: block;
        margin: 15px 0 5px;
        color: #d3ffd3;
      }

      input[type="file"] {
        display: block;
        margin-bottom: 1px;
        padding: 8px;
        width: 100%;
        border: 1px solid #ddd;
        border-radius: 4px;
        box-sizing: border-box;
      }

      button {
        background-color: #28a745;
        color: white;
        border: none;
        padding: 10px 15px;
        cursor: pointer;
        font-size: 16px;
        border-radius: 5px;
        width: 50%;
        transition: background-color 0.3s ease;
        margin: 5px 0;
      }

      #cancelButton {
        background: crimson;
      }

      button:hover {
        background-color: #218838;
      }

      #progressDisplay {
        margin-top: 15px;
        text-align: center;
        font-weight: bold;
        margin: 5px 0;
      }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.7.1/jszip.min.js"></script>
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
      import {
        getDatabase,
        ref,
        set,
      } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js";
      import {
        getStorage,
        ref as storageRef,
        uploadBytesResumable,
        getDownloadURL,
      } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-storage.js";

      import { songs } from "./songs.js";

      // Firebase configuration (replace with your own config)
      const firebaseConfig = {
        apiKey: "AIzaSyAzlkLnnehGZbkVHRs_IvzPTq7KFzU2LSE",
        authDomain: "spotify-clone-b478a.firebaseapp.com",
        databaseURL: "https://spotify-clone-b478a-default-rtdb.firebaseio.com",
        projectId: "spotify-clone-b478a",
        storageBucket: "spotify-clone-b478a.appspot.com",
        messagingSenderId: "729343608032",
        appId: "1:729343608032:web:d2563fdd966101ed44bc85",
      };

      let uploadedCount = 0;
      let totalFiles = 0;
      let uploadedFiles = 0;
      let isUploading = false;
      let cancelRequested = false;
      let songFiles = {};
      let coverFiles = {};
      let totalFilesToUpload = 0;
      let uploadedFileCount = 0;

      // Show upload count
      function updateUploadCount() {
        document.getElementById(
          "upload-count"
        ).innerText = `Uploaded: ${uploadedFiles} / ${totalFiles}`;
      }

      // Warn if user refreshes during upload
      window.addEventListener("beforeunload", (e) => {
        if (isUploading) {
          e.preventDefault();
          e.returnValue = "";
        }
      });

      // Cancel logic
      document.getElementById("cancelButton").addEventListener("click", () => {
        if (isUploading) {
          const confirmCancel = confirm(
            "Are you sure you want to cancel the upload?"
          );
          if (confirmCancel) {
            cancelRequested = true;
          }
        }
      });

      // Load and extract ZIP
      async function loadZipFile(file, fileStore, prefix) {
        const zip = new JSZip();
        const zipContent = await zip.loadAsync(file);
        let count = 0;

        console.log(
          `üì¶ Files in ${prefix} ZIP:`,
          Object.keys(zipContent.files)
        );
        for (let filename in zipContent.files) {
          const fileData = zipContent.files[filename];
          if (!fileData.dir) {
            const fileName = filename.split("/").pop();
            const blob = await fileData.async("blob");
            fileStore[fileName] = blob;
            count++;
          }
        }

        totalFilesToUpload += count; // ‚úÖ Track total files found
        console.log(`‚úÖ Loaded ${prefix} files: ${count}`);
      }

      // Zip file inputs
      document
        .getElementById("songZipFile")
        .addEventListener("change", async (e) => {
          await loadZipFile(e.target.files[0], songFiles, "song/");
        });
      document
        .getElementById("coverZipFile")
        .addEventListener("change", async (e) => {
          await loadZipFile(e.target.files[0], coverFiles, "cover/");
        });

      const app = initializeApp(firebaseConfig);
      const storage = getStorage(app);
      const database = getDatabase(app);

      // Upload files
      document
        .getElementById("uploadButton")
        .addEventListener("click", async () => {
          const progressDisplay = document.getElementById("progressDisplay");
          if (
            !Object.keys(songFiles).length ||
            !Object.keys(coverFiles).length
          ) {
            alert("Please select both ZIP files first.");
            return;
          }

          isUploading = true;
          cancelRequested = false;
          uploadedFiles = 0;
          totalFiles = songs.length * 2;
          updateUploadCount();

          for (let i = 0; i < songs.length; i++) {
            if (cancelRequested) break;

            const song = songs[i];
            const songFile = songFiles[song.filePath.split("/")[1]];
            const coverFile = coverFiles[song.coverPath.split("/")[1]];

            if (!songFile || !coverFile) {
              console.warn(`Missing file for ${song.songName}, skipping`);
              continue;
            }

            const songPath = `songs/${song.songName}.mp3`;
            const coverPath = `covers/${song.songName}.jpg`;

            try {
              const songURL = await uploadFile(
                songFile,
                songPath,
                progressDisplay
              );
              const coverURL = await uploadFile(
                coverFile,
                coverPath,
                progressDisplay
              );

              await updateDatabase(song, songPath, coverURL);
            } catch (err) {
              console.error(`Upload failed:`, err);
            }
          }

          // Cleanup
          isUploading = false;
          cancelRequested = false;
          songFiles = {};
          coverFiles = {};
          progressDisplay.textContent = "Upload complete.";
          document.getElementById("songZipFile").value = "";
          document.getElementById("coverZipFile").value = "";
        });

      // File upload with progress
      // File upload with progress
      async function uploadFile(file, path, progressElement) {
        return new Promise((resolve, reject) => {
          const fileRef = storageRef(storage, path);
          const uploadTask = uploadBytesResumable(fileRef, file);

          // Track upload progress
          uploadTask.on(
            "state_changed",
            (snapshot) => {
              const progress =
                (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
              if (!isNaN(progress)) {
                progressElement.textContent = `Progress: ${progress.toFixed(
                  2
                )}%`;
                console.log(`Uploading ${path} - ${progress.toFixed(2)}%`);
              }
            },
            (error) => {
              console.error(`‚ùå Upload error for ${path}:`, error);
              reject(error);
            },
            async () => {
              if (cancelRequested) {
                console.warn(`‚ö†Ô∏è Upload cancelled: ${path}`);
                reject("Upload cancelled by user");
                return;
              }

              uploadedFiles++;
              updateUploadCount(); // ‚úÖ Should update X/Y in UI
              const url = await getDownloadURL(uploadTask.snapshot.ref);
              resolve(url);
            }
          );

          // Cancel if already requested before it starts
          if (cancelRequested) {
            uploadTask.cancel();
            reject("Upload cancelled by user.");
          }
        });
      }

      // Store song + cover URL in database
      async function updateDatabase(song, songStoragePath, coverURL) {
        const songRef = ref(database, "songs/" + song.songName);
        const songData = {
          artist: song.artist,
          songURL: `https://firebasestorage.googleapis.com/v0/b/${
            firebaseConfig.storageBucket
          }/o/${encodeURIComponent(songStoragePath)}?alt=media`,
          coverURL: coverURL,
        };
        await set(songRef, songData);
        console.log(`Database updated for ${song.songName}`, songData);
      }
    </script>
  </head>

  <body>
    <div class="container">
      <h1>
        Upload Songs and Covers <br />
        To the Database
      </h1>

      <!-- Songs.js File Upload  check for songs.js . the file orderand details are mentioned inside of this file -->
      <label for="songsFile">Upload songs.js:</label>
      <!-- imported default from file  -->
      <input type="file" id="songsFile" accept=".js" disabled /><br />
      <!-- Disabled since we are importing directly -->

      <!-- Song ZIP file upload -->
      <label for="songZipFile">Upload song folder ZIP:</label>
      <input type="file" id="songZipFile" accept=".zip" /><br />

      <!-- Cover ZIP file upload -->
      <label for="coverZipFile">Upload cover folder ZIP:</label>
      <input type="file" id="coverZipFile" accept=".zip" /><br />

      <button id="uploadButton">Upload to Firebase</button>

      <div id="progressDisplay">Progress: 0%</div>

      <div id="upload-count">Uploaded: 0 / 0</div>

      <!-- Add to your upload2.html -->
      <button id="cancelButton" disabled>Cancel Upload</button>
    </div>
  </body>
</html>
